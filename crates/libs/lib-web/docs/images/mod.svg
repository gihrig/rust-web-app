<?xml version="1.0" encoding="UTF-8"?>
<svg width="900" height="720" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .bg { fill: #2f2f2f; }
      .arrow-fill { fill: #AAA; }
      .stroke-primary { stroke: #AAA; stroke-width: 2; fill: none; }
      .stroke-dashed { stroke: #AAA; stroke-width: 1.5; stroke-dasharray: 5,5; fill: none; }
      .line-primary { stroke: #AAA; stroke-width: 2; }
      .text-title { font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; fill: white; text-anchor: middle; }
      .text-section { font-family: Arial, sans-serif; font-size: 16px; font-weight: bold; fill: white; text-anchor: middle; }
      .text-box-title { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; fill: white; text-anchor: middle; }
      .text-code { font-family: Arial, sans-serif; font-size: 12px; fill: white; text-anchor: middle; }
      .text-small { font-family: Arial, sans-serif; font-size: 10px; fill: white; text-anchor: middle; }
      .rect-layer { fill: #3D3D3D; }
      .rect-sublayer { fill: #4D4D4D; }
      .rect-process { fill: #5D5D5D; }
      .rect-error { fill: #6D3D3D; }
      .rect-data { fill: #3D5D3D; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7"
     refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" class="arrow-fill" />
    </marker>
  </defs>

  <rect width="900" height="720" class="bg"/>

  <!-- Function Entry Point -->
  <rect x="20" y="30" width="860" height="50" rx="5" class="stroke-primary rect-layer"/>
  <text x="450" y="60" class="text-title">log_request() Function Entry</text>

  <!-- Input Parameters -->
  <rect x="20" y="120" width="860" height="60" rx="5" class="stroke-primary rect-layer"/>
  <text x="450" y="145" class="text-section">Input Parameters</text>
  <text x="150" y="165" class="text-code">http_method, uri</text>
  <text x="350" y="165" class="text-code">req_stamp</text>
  <text x="550" y="165" class="text-code">rpc_info, ctx</text>
  <text x="750" y="165" class="text-code">web_error, client_error</text>

  <!-- Error Preparation -->
  <rect x="50" y="220" width="250" height="60" rx="5" class="stroke-primary rect-process"/>
  <text x="175" y="245" class="text-box-title">Error Preparation</text>
  <text x="175" y="265" class="text-code">Extract error_type &amp; error_data</text>

  <!-- Request Info Extraction -->
  <rect x="350" y="220" width="250" height="60" rx="5" class="stroke-primary rect-process"/>
  <text x="475" y="245" class="text-box-title">Request Info Extraction</text>
  <text x="475" y="265" class="text-code">uuid, time_in from req_stamp</text>

  <!-- Duration Calculation -->
  <rect x="650" y="220" width="200" height="60" rx="5" class="stroke-primary rect-process"/>
  <text x="750" y="245" class="text-box-title">Duration Calculation</text>
  <text x="750" y="265" class="text-code">microsecond precision</text>

  <!-- RequestLogLine Creation -->
  <rect x="20" y="320" width="860" height="80" rx="5" class="stroke-primary rect-data"/>
  <text x="450" y="345" class="text-section">RequestLogLine Struct Creation</text>
  <text x="150" y="365" class="text-code">uuid, timestamp, duration_ms</text>
  <text x="450" y="365" class="text-code">http_path, http_method</text>
  <text x="750" y="365" class="text-code">user_id, rpc_info</text>
  <text x="450" y="385" class="text-code">client_error_type, error_type, error_data</text>

  <!-- Debug Logging -->
  <rect x="20" y="440" width="860" height="50" rx="5" class="stroke-primary rect-layer"/>
  <text x="450" y="470" class="text-section">Debug JSON Logging</text>

  <!-- Future Enhancement -->
  <rect x="20" y="530" width="860" height="60" rx="5" class="stroke-primary rect-sublayer"/>
  <text x="450" y="555" class="text-box-title">Future Enhancement Placeholder</text>
  <text x="450" y="575" class="text-code">TODO: Cloud-watch &amp; pack_and_send logic</text>

  <!-- Success Return -->
  <rect x="20" y="630" width="860" height="50" rx="5" class="stroke-primary rect-layer"/>
  <text x="450" y="660" class="text-title">Return Ok(())</text>

  <!-- Flow Arrows -->
  <!-- Main entry flow -->
  <line x1="450" y1="80" x2="450" y2="120" class="line-primary" marker-end="url(#arrowhead)"/>
  
  <!-- Parameter processing -->
  <line x1="175" y1="180" x2="175" y2="220" class="line-primary" marker-end="url(#arrowhead)"/>
  <line x1="475" y1="180" x2="475" y2="220" class="line-primary" marker-end="url(#arrowhead)"/>
  <line x1="750" y1="180" x2="750" y2="220" class="line-primary" marker-end="url(#arrowhead)"/>
  
  <!-- Processing to struct creation -->
  <line x1="175" y1="280" x2="175" y2="320" class="line-primary" marker-end="url(#arrowhead)"/>
  <line x1="475" y1="280" x2="475" y2="320" class="line-primary" marker-end="url(#arrowhead)"/>
  <line x1="750" y1="280" x2="750" y2="320" class="line-primary" marker-end="url(#arrowhead)"/>
  
  <!-- Struct to debug logging -->
  <line x1="450" y1="400" x2="450" y2="440" class="line-primary" marker-end="url(#arrowhead)"/>
  
  <!-- Debug to future enhancement -->
  <line x1="450" y1="490" x2="450" y2="530" class="line-primary" marker-end="url(#arrowhead)"/>
  
  <!-- Future enhancement to success -->
  <line x1="450" y1="590" x2="450" y2="630" class="line-primary" marker-end="url(#arrowhead)"/>

  <!-- Side annotations -->
  <text x="120" y="310" class="text-small">Optional fields</text>
  <text x="800" y="310" class="text-small">Timing precision</text>
  <text x="120" y="520" class="text-small">Structured output</text>
  <text x="800" y="520" class="text-small">Cloud integration</text>

</svg>
