<?xml version="1.0" encoding="UTF-8"?>
<svg width="1000" height="950" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .bg { fill: #2f2f2f; }
      .arrow-fill { fill: #AAA; }
      .stroke-primary { stroke: #AAA; stroke-width: 2; fill: none; }
      .stroke-dashed { stroke: #AAA; stroke-width: 1.5; stroke-dasharray: 5,5; fill: none; }
      .line-primary { stroke: #AAA; stroke-width: 2; }
      .text-title { font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; fill: white; text-anchor: middle; }
      .text-section { font-family: Arial, sans-serif; font-size: 16px; font-weight: bold; fill: white; text-anchor: middle; }
      .text-box-title { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; fill: white; text-anchor: middle; }
      .text-code { font-family: Arial, sans-serif; font-size: 12px; fill: white; text-anchor: middle; }
      .text-small { font-family: Arial, sans-serif; font-size: 10px; fill: white; text-anchor: middle; }
      .rect-layer { fill: #3D3D3D; }
      .rect-sublayer { fill: #4D4D4D; }
      .rect-process { fill: #5D5D5D; }
      .rect-error { fill: #6D3D3D; }
      .rect-data { fill: #3D5D3D; }
      .rect-extractor { fill: #3D3D5D; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" class="arrow-fill" />
    </marker>
  </defs>
  <rect width="1000" height="950" class="bg" x="2" y="1" />
  <!-- Module Entry Point -->
  <rect x="30" y="30" width="940" height="201" rx="5" class="stroke-primary rect-layer" />
  <text x="500" y="60" class="text-title">mw_auth Module - Authentication Middleware Public Interface</text>

  <!-- Request Entry Points -->
  <!-- Request Extension Storage -->
  <rect x="61" y="91" width="278" height="108" rx="4" class="stroke-primary rect-data" />
  <text x="196" y="118" class="text-section">mw_ctx_resolver</text>
  <text x="196" y="136" class="text-code">State(mm), cookies, req, next</text>
  <text x="190" y="156" class="text-code">Request Extension Storage</text>
  <text x="190" y="171" class="text-small">Store result for downstream use</text>
  <text x="190" y="187" class="text-code">req.extensions_mut().insert(ctx_ext_result)</text>

  <!-- mw_ctx_require flow -->
  <rect x="378" y="90" width="199" height="109" rx="4" class="stroke-primary rect-sublayer" />
  <text x="480" y="116" class="text-section">mw_ctx_require</text>
  <text x="480" y="138" class="text-code">ctx: Result&lt;CtxW&gt;, req, next</text>
  <text x="480" y="153" class="text-code">-&gt; Result&lt;Response&gt;</text>
  <text x="476" y="169" class="text-code">ctx? - Force successful auth</text>
  <text x="476" y="185" class="text-small">Propagates auth errors</text>

  <!-- Extractor Logic -->
  <rect x="610" y="90" width="199" height="108" rx="4" class="stroke-primary rect-sublayer" />
  <text x="712" y="118" class="text-section">CtxW</text>
  <text x="710" y="136" class="text-code">lib-core::ctx::Ctx</text>
  <text x="710" y="153" class="text-code">Extract from request extensions</text>
  <text x="710" y="169" class="text-small">Axum Extractor struct</text>
  <text x="710" y="185" class="text-small">Error: CtxNotInRequestExt</text>

  <!-- CtxExtError -->
  <rect x="838" y="89" width="111" height="110" rx="2" class="stroke-primary rect-sublayer" />
  <text x="895" y="116" class="text-section">CtxExtError</text>
  <text x="895" y="138" class="text-code">error enum</text>

  <!-- Core Authentication Logic -->
  <rect x="32" y="260" width="217" height="670" rx="3" class="stroke-primary rect-layer" />
  <line x1="140" y1="649" x2="140" y2="668" class="line-primary" marker-end="url(#arrowhead)" />
  <text x="140" y="290" class="text-section">ctx_resolve() - auth logic</text>
  <text x="138" y="308" class="text-code">mm, &amp;cookies -&gt; CtxExtResult</text>

  <!-- Token Extraction -->
  <rect x="50" y="330" width="179" height="77" rx="3" class="stroke-primary rect-process" />
  <text x="134" y="357" class="text-box-title">Token Extraction</text>
  <text x="134" y="378" class="text-code">Get AUTH_TOKEN cookie</text>
  <text x="134" y="396" class="text-small">Error: TokenNotInCookie</text>
  <!-- Token Parsing -->
  <rect x="51" y="428" width="177" height="80" rx="4" class="stroke-primary rect-process" />
  <text x="139" y="452" class="text-box-title">Token Parsing</text>
  <text x="139" y="472" class="text-code">Parse token string</text>
  <text x="139" y="492" class="text-small">Error: TokenWrongFormat</text>
  <!-- User Lookup -->
  <rect x="50" y="530" width="178" height="77" rx="4" class="stroke-primary rect-process" />
  <text x="136" y="555" class="text-box-title">User Lookup</text>
  <text x="138" y="575" class="text-code">UserBmc::first_by_username</text>
  <text x="138" y="595" class="text-small">Error: UserNotFound</text>
  <!-- Token Validation -->
  <rect x="50" y="628" width="180" height="80" rx="4" class="stroke-primary rect-process" />
  <text x="140" y="653" class="text-box-title">Token Validation</text>
  <text x="140" y="673" class="text-code">validate_web_token</text>
  <text x="140" y="693" class="text-small">Error: FailValidate</text>
  <!-- Token Update -->
  <rect x="51" y="730" width="178" height="78" rx="4" class="stroke-primary rect-data" />
  <text x="140" y="753" class="text-box-title">Token Update</text>
  <text x="140" y="773" class="text-code">set_token_cookie</text>
  <text x="140" y="793" class="text-small">Error: CannotSetTokenCookie</text>
  <!-- Context Creation -->
  <rect x="49" y="829" width="180" height="80" rx="4" class="stroke-primary rect-data" />
  <text x="138" y="855" class="text-box-title">Context Creation</text>
  <text x="138" y="875" class="text-code">Ctx::new(user.id).map(CtxW)</text>
  <text x="138" y="895" class="text-small">Error: CtxCreateFail</text>
  <!-- Error Handling -->
  <rect x="304" y="334" width="457" height="577" rx="5" class="stroke-primary rect-error" />
  <text x="532" y="377" class="text-section">Error Handling in mw_ctx_resolver</text>
  <text x="532" y="397" class="text-code">Remove AUTH_TOKEN cookie on error</text>
  <text x="532" y="417" class="text-code">(unless Error: TokenNotInCookie)</text>

  <!-- Flow Arrows -->
  <!-- mw_ctx_resolver to/from ctx_resolve -->
  <line x1="100" y1="201" x2="100" y2="258" class="line-primary" marker-end="url(#arrowhead)" />
  <line x1="209" y1="258" x2="209" y2="202" class="line-primary" marker-end="url(#arrowhead)" />
  <line x1="322" y1="197" x2="322" y2="334" class="line-primary" marker-end="url(#arrowhead)" />
  <!-- Sequential process flow -->
  <line x1="140" y1="407" x2="140" y2="426" class="line-primary" marker-end="url(#arrowhead)" />
  <line x1="140" y1="509" x2="140" y2="528" class="line-primary" marker-end="url(#arrowhead)" />
  <line x1="140" y1="607" x2="140" y2="626" class="line-primary" marker-end="url(#arrowhead)" />
  <line x1="140" y1="709" x2="140" y2="728" class="line-primary" marker-end="url(#arrowhead)" />
  <line x1="140" y1="808" x2="140" y2="828" class="line-primary" marker-end="url(#arrowhead)" />
  <!-- Error flows -->
  <line x1="219" y1="391" x2="304" y2="391" class="stroke-dashed" marker-end="url(#arrowhead)" />
  <line x1="219" y1="490" x2="304" y2="490" class="stroke-dashed" marker-end="url(#arrowhead)" />
  <line x1="218" y1="591" x2="303" y2="591" class="stroke-dashed" marker-end="url(#arrowhead)" />
  <line x1="219" y1="691" x2="304" y2="691" class="stroke-dashed" marker-end="url(#arrowhead)" />
  <line x1="219" y1="791" x2="304" y2="791" class="stroke-dashed" marker-end="url(#arrowhead)" />
  <line x1="219" y1="891" x2="304" y2="891" class="stroke-dashed" marker-end="url(#arrowhead)" />
</svg>
