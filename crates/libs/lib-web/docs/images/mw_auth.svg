<?xml version="1.0" encoding="UTF-8"?>
<svg width="1000" height="900" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .bg { fill: #2f2f2f; }
      .arrow-fill { fill: #AAA; }
      .stroke-primary { stroke: #AAA; stroke-width: 2; fill: none; }
      .stroke-dashed { stroke: #AAA; stroke-width: 1.5; stroke-dasharray: 5,5; fill: none; }
      .line-primary { stroke: #AAA; stroke-width: 2; }
      .text-title { font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; fill: white; text-anchor: middle; }
      .text-section { font-family: Arial, sans-serif; font-size: 16px; font-weight: bold; fill: white; text-anchor: middle; }
      .text-box-title { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; fill: white; text-anchor: middle; }
      .text-code { font-family: Arial, sans-serif; font-size: 12px; fill: white; text-anchor: middle; }
      .text-small { font-family: Arial, sans-serif; font-size: 10px; fill: white; text-anchor: middle; }
      .rect-layer { fill: #3D3D3D; }
      .rect-sublayer { fill: #4D4D4D; }
      .rect-process { fill: #5D5D5D; }
      .rect-error { fill: #6D3D3D; }
      .rect-data { fill: #3D5D3D; }
      .rect-extractor { fill: #3D3D5D; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7"
     refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" class="arrow-fill" />
    </marker>
  </defs>

  <rect width="1000" height="900" class="bg"/>

  <!-- Module Entry Point -->
  <rect x="20" y="30" width="960" height="50" rx="5" class="stroke-primary rect-layer"/>
  <text x="500" y="60" class="text-title">mw_auth Module - Authentication Middleware</text>

  <!-- Request Entry Points -->
  <rect x="50" y="120" width="280" height="60" rx="5" class="stroke-primary rect-sublayer"/>
  <text x="190" y="145" class="text-section">mw_ctx_resolver</text>
  <text x="190" y="165" class="text-code">State(mm), cookies, req, next</text>

  <rect x="360" y="120" width="280" height="60" rx="5" class="stroke-primary rect-sublayer"/>
  <text x="500" y="145" class="text-section">mw_ctx_require</text>
  <text x="500" y="165" class="text-code">ctx: Result&lt;CtxW&gt;, req, next</text>

  <rect x="670" y="120" width="280" height="60" rx="5" class="stroke-primary rect-extractor"/>
  <text x="810" y="145" class="text-section">CtxW Extractor</text>
  <text x="810" y="165" class="text-code">FromRequestParts trait</text>

  <!-- Context Resolution Process -->
  <rect x="20" y="220" width="960" height="50" rx="5" class="stroke-primary rect-layer"/>
  <text x="500" y="250" class="text-section">ctx_resolve() - Core Authentication Logic</text>

  <!-- Token Extraction -->
  <rect x="50" y="300" width="200" height="80" rx="5" class="stroke-primary rect-process"/>
  <text x="150" y="325" class="text-box-title">Token Extraction</text>
  <text x="150" y="345" class="text-code">Get AUTH_TOKEN cookie</text>
  <text x="150" y="365" class="text-small">Return: TokenNotInCookie</text>

  <!-- Token Parsing -->
  <rect x="280" y="300" width="200" height="80" rx="5" class="stroke-primary rect-process"/>
  <text x="380" y="325" class="text-box-title">Token Parsing</text>
  <text x="380" y="345" class="text-code">Parse token string</text>
  <text x="380" y="365" class="text-small">Return: TokenWrongFormat</text>

  <!-- User Lookup -->
  <rect x="510" y="300" width="200" height="80" rx="5" class="stroke-primary rect-process"/>
  <text x="610" y="325" class="text-box-title">User Lookup</text>
  <text x="610" y="345" class="text-code">UserBmc::first_by_username</text>
  <text x="610" y="365" class="text-small">Return: UserNotFound</text>

  <!-- Token Validation -->
  <rect x="740" y="300" width="200" height="80" rx="5" class="stroke-primary rect-process"/>
  <text x="840" y="325" class="text-box-title">Token Validation</text>
  <text x="840" y="345" class="text-code">validate_web_token</text>
  <text x="840" y="365" class="text-small">Return: FailValidate</text>

  <!-- Token Update and Context Creation -->
  <rect x="200" y="420" width="250" height="80" rx="5" class="stroke-primary rect-data"/>
  <text x="325" y="445" class="text-box-title">Token Update</text>
  <text x="325" y="465" class="text-code">set_token_cookie</text>
  <text x="325" y="485" class="text-small">Return: CannotSetTokenCookie</text>

  <rect x="480" y="420" width="250" height="80" rx="5" class="stroke-primary rect-data"/>
  <text x="605" y="445" class="text-box-title">Context Creation</text>
  <text x="605" y="465" class="text-code">Ctx::new(user.id).map(CtxW)</text>
  <text x="605" y="485" class="text-small">Return: CtxCreateFail</text>

  <!-- Error Handling -->
  <rect x="20" y="540" width="460" height="80" rx="5" class="stroke-primary rect-error"/>
  <text x="250" y="565" class="text-section">Error Handling in mw_ctx_resolver</text>
  <text x="250" y="585" class="text-code">Remove AUTH_TOKEN cookie on error</text>
  <text x="250" y="605" class="text-small">(except TokenNotInCookie)</text>

  <!-- Request Extension Storage -->
  <rect x="520" y="540" width="460" height="80" rx="5" class="stroke-primary rect-data"/>
  <text x="750" y="565" class="text-section">Request Extension Storage</text>
  <text x="750" y="585" class="text-code">req.extensions_mut().insert(ctx_ext_result)</text>
  <text x="750" y="605" class="text-small">Store result for downstream use</text>

  <!-- Context Requirement Check -->
  <rect x="360" y="660" width="280" height="80" rx="5" class="stroke-primary rect-process"/>
  <text x="500" y="685" class="text-section">mw_ctx_require</text>
  <text x="500" y="705" class="text-code">ctx? - Force successful auth</text>
  <text x="500" y="725" class="text-small">Propagates auth errors</text>

  <!-- Extractor Logic -->
  <rect x="670" y="660" width="280" height="80" rx="5" class="stroke-primary rect-extractor"/>
  <text x="810" y="685" class="text-section">CtxW Extractor</text>
  <text x="810" y="705" class="text-code">Extract from request extensions</text>
  <text x="810" y="725" class="text-small">Return: CtxNotInRequestExt</text>

  <!-- Success Path -->
  <rect x="20" y="780" width="960" height="50" rx="5" class="stroke-primary rect-layer"/>
  <text x="500" y="810" class="text-title">Success: Authenticated Context Available</text>

  <!-- Flow Arrows -->
  <!-- Entry to middleware functions -->
  <line x1="190" y1="80" x2="190" y2="120" class="line-primary" marker-end="url(#arrowhead)"/>
  <line x1="500" y1="80" x2="500" y2="120" class="line-primary" marker-end="url(#arrowhead)"/>
  <line x1="810" y1="80" x2="810" y2="120" class="line-primary" marker-end="url(#arrowhead)"/>

  <!-- mw_ctx_resolver to ctx_resolve -->
  <line x1="190" y1="180" x2="190" y2="220" class="line-primary" marker-end="url(#arrowhead)"/>

  <!-- ctx_resolve process flow -->
  <line x1="150" y1="270" x2="150" y2="300" class="line-primary" marker-end="url(#arrowhead)"/>
  <line x1="380" y1="270" x2="380" y2="300" class="line-primary" marker-end="url(#arrowhead)"/>
  <line x1="610" y1="270" x2="610" y2="300" class="line-primary" marker-end="url(#arrowhead)"/>
  <line x1="840" y1="270" x2="840" y2="300" class="line-primary" marker-end="url(#arrowhead)"/>

  <!-- Sequential process flow -->
  <line x1="250" y1="340" x2="280" y2="340" class="line-primary" marker-end="url(#arrowhead)"/>
  <line x1="480" y1="340" x2="510" y2="340" class="line-primary" marker-end="url(#arrowhead)"/>
  <line x1="710" y1="340" x2="740" y2="340" class="line-primary" marker-end="url(#arrowhead)"/>

  <!-- Token validation to token update -->
  <line x1="740" y1="380" x2="325" y2="420" class="stroke-dashed" marker-end="url(#arrowhead)"/>
  <line x1="450" y1="460" x2="480" y2="460" class="line-primary" marker-end="url(#arrowhead)"/>

  <!-- Context creation to storage -->
  <line x1="605" y1="500" x2="750" y2="540" class="line-primary" marker-end="url(#arrowhead)"/>
  <line x1="325" y1="500" x2="250" y2="540" class="stroke-dashed" marker-end="url(#arrowhead)"/>

  <!-- mw_ctx_require flow -->
  <line x1="500" y1="180" x2="500" y2="660" class="line-primary" marker-end="url(#arrowhead)"/>

  <!-- Extractor flow -->
  <line x1="810" y1="180" x2="810" y2="660" class="line-primary" marker-end="url(#arrowhead)"/>

  <!-- Success path -->
  <line x1="500" y1="740" x2="500" y2="780" class="line-primary" marker-end="url(#arrowhead)"/>
  <line x1="810" y1="740" x2="810" y2="780" class="line-primary" marker-end="url(#arrowhead)"/>

</svg>